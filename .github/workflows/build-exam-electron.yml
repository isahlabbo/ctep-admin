name: Build Exam Electron App

on:
  workflow_dispatch:
    inputs:
      exam_sql_url:
        description: "Signed URL of the sqlite exam file"
        required: true
      exam_filename:
        description: "Original filename of the sqlite file"
        required: true
      build_id:
        description: "Unique ID for this build"
        required: true
      callback_url:
        description: "Where to POST the final .exe installer"
        required: true

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 120

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js (cache npm)
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: Install dependencies (npm ci)
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Create data directory
        run: |
          mkdir -p ./data

      - name: print inputs
        run: |
          echo "exam_sql_url=${{ github.event.inputs.exam_sql_url }}"
          echo "exam_filename=${{ github.event.inputs.exam_filename }}"
          echo "build_id=${{ github.event.inputs.build_id }}"
          echo "callback_url=${{ github.event.inputs.callback_url }}"

      - name: Download sqlite file (robust, verbose)
        id: download_sqlite
        run: |
          set -euo pipefail
          echo "Downloading sqlite from: ${{ github.event.inputs.exam_sql_url }}"
          mkdir -p data debug_artifact
          echo "${{ github.event.inputs.exam_sql_url }}" > debug_artifact/exam_sql_url.txt

          LOG=debug_artifact/download.log
          HEADERS=debug_artifact/headers_last.txt
          rm -f $LOG $HEADERS || true

          MAX=3
          SLEEP=3
          i=0
          while [ $i -lt $MAX ]; do
            i=$((i+1))
            echo "Attempt #$i" | tee -a $LOG
            curl -fSL -D $HEADERS -o "data/${{ github.event.inputs.exam_filename }}" -v "${{ github.event.inputs.exam_sql_url }}" 2>> $LOG || true
            if [ -s "data/${{ github.event.inputs.exam_filename }}" ]; then
              echo "Downloaded data/${{ github.event.inputs.exam_filename }} (attempt #$i)" | tee -a $LOG
              ls -l "data/${{ github.event.inputs.exam_filename }}" | tee -a $LOG
              break
            fi
            echo "Attempt #$i failed, sleeping $SLEEP seconds" | tee -a $LOG
            sleep $SLEEP
            SLEEP=$((SLEEP * 2))
          done

          if [ ! -s "data/${{ github.event.inputs.exam_filename }}" ]; then
            echo "ERROR: Failed to download sqlite after $MAX attempts" | tee -a $LOG
            echo "--- curl HEAD ---" >> $LOG
            cat $HEADERS >> $LOG || true
            echo "Uploading debug artifact for inspection..."
            ls -la debug_artifact || true
            exit 1
          fi

      - name: Show downloaded DB
        run: |
          echo "Contents of data/:"
          ls -la data || true

      - name: Build Electron App (Windows)
        run: |
          if npm run | grep -q 'build'; then
            npm run build || true
          fi
          npx electron-builder --win --config electron-builder.yml

      - name: Find generated EXE (PowerShell)
        id: find_exe
        shell: pwsh
        run: |
          $file = Get-ChildItem -Path "dist" -Recurse -Filter *.exe | Select-Object -First 1
          if ($null -eq $file) {
            Write-Host "NO_EXE_FOUND"
            exit 2
          }
          Write-Host "Found EXE: $($file.FullName)"
          Add-Content -Path $env:GITHUB_ENV -Value ("FILE_PATH=$($file.FullName)")

      - name: Upload installer to Laravel callback (PowerShell)
        id: upload_callback
        shell: pwsh
        env:
          CALLBACK_URL: ${{ github.event.inputs.callback_url }}
          BUILD_ID: ${{ github.event.inputs.build_id }}
          FILE_PATH: ${{ env.FILE_PATH }}
        run: |
          if (-not (Test-Path $env:FILE_PATH)) {
            Write-Host "Installer not found at $env:FILE_PATH"
            exit 2
          }
          Write-Host "Posting installer $env:FILE_PATH to $env:CALLBACK_URL"
          $resp = curl -X POST $env:CALLBACK_URL `
            -H "X-BUILD-CALLBACK-TOKEN: ${{ secrets.BUILD_CALLBACK_TOKEN }}" `
            -F "build_id=$env:BUILD_ID" `
            -F "artifact=@$env:FILE_PATH" `
            -i --silent
          Write-Host "Callback response:"
          Write-Host $resp
          if ($LASTEXITCODE -ne 0) {
            Write-Host "POST to callback failed (exit $LASTEXITCODE). Uploading artifact to GitHub as fallback."
            exit 3
          }

      - name: Upload built EXE as artifact (fallback)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: exam-installer-${{ github.run_id }}
          path: ${{ env.FILE_PATH }}

      - name: Completed
        if: success()
        run: echo "Build completed successfully"
