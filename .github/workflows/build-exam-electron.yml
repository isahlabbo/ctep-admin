name: Build Exam Electron App

on:
  workflow_dispatch:
    inputs:
      exam_sql_url:
        description: "Signed URL of the sqlite exam file"
        required: true
      exam_filename:
        description: "Original filename of the sqlite file"
        required: true
      build_id:
        description: "Unique ID for this build"
        required: true
      callback_url:
        description: "Where to POST the final .exe installer"
        required: true

jobs:
  build:
    runs-on: windows-latest

    steps:
      # 1. Checkout source code
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2. Set up Node.js
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # 3. Install dependencies
      - name: Install dependencies
        run: npm install

      # 4. Create build directory for sqlite database
      - name: Create data directory
        run: mkdir -p ./data

      # 5. Download sqlite DB sent from Laravel
      - name: Download sqlite file
        run: |
          curl -L "${{ github.event.inputs.exam_sql_url }}" -o "./data/${{ github.event.inputs.exam_filename }}"
      
      # 6. Confirm file exists
      - name: Show downloaded DB
        run: dir ./data

      # 7. Build Electron app using electron-builder
      - name: Build Electron App (Windows)
        run: |
          npx electron-builder --win --config electron-builder.yml

      # 8. Upload artifact from dist
      - name: Find generated EXE
        id: find_exe
        run: |
          $file = Get-ChildItem -Path "dist" -Filter *.exe | Select-Object -First 1
          echo "FILE_PATH=$($file.FullName)" >> $env:GITHUB_ENV
          echo "Found: $($file.FullName)"

      # 9. POST installer back to Laravel callback URL
      - name: Upload installer to Laravel
        run: |
          curl -X POST "${{ github.event.inputs.callback_url }}" ^
          -H "Content-Type: multipart/form-data" ^
          -F "build_id=${{ github.event.inputs.build_id }}" ^
          -F "file=@${{ env.FILE_PATH }}"

      # 10. Mark workflow success
      - name: Completed
        run: echo "Build completed successfully"
