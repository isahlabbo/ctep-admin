name: Build Exam Electron App

on:
  workflow_dispatch:
    inputs:
      exam_sql_url:
        description: "Signed URL of the sqlite exam file"
        required: true
      exam_filename:
        description: "Original filename of the sqlite file"
        required: true
      build_id:
        description: "Unique ID for this build"
        required: true
      callback_url:
        description: "Where to POST the final .exe installer"
        required: true

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 120

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js (v18) and enable npm cache
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Show runner + node info (debug)
        run: |
          echo "Runner OS: $RUNNER_OS"
          node --version || true
          npm --version || true
          echo "npm config:"
          npm config list || true

      - name: Install dependencies (npm ci with retries, fallback to npm install)
        shell: bash
        env:
          NPM_CONFIG_FETCH_RETRIES: 3
          NPM_CONFIG_FETCH_TIMEOUT: 60000
          NPM_CONFIG_LOGLEVEL: verbose
        run: |
          set -euo pipefail
          if [ -f package-lock.json ]; then
            echo "Using npm ci (lockfile exists)"
            n=0
            until [ $n -ge 3 ]
            do
              n=$((n+1))
              echo "npm ci attempt #$n"
              npm ci && break
              echo "npm ci failed (attempt $n)"
              sleep $((n * 2))
            done
            if [ ! -d node_modules ]; then
              echo "npm ci failed after retries, falling back to npm install (may be slower)"
              npm install --legacy-peer-deps
            fi
          else
            echo "No package-lock.json found â€” using npm install"
            npm install --legacy-peer-deps
          fi

      - name: Create data directory
        run: |
          mkdir -p ./data

      - name: Print inputs (debug)
        run: |
          echo "exam_sql_url=${{ github.event.inputs.exam_sql_url }}"
          echo "exam_filename=${{ github.event.inputs.exam_filename }}"
          echo "build_id=${{ github.event.inputs.build_id }}"
          echo "callback_url=${{ github.event.inputs.callback_url }}"

      - name: Download sqlite file (robust, verbose)
        id: download_sqlite
        run: |
          set -euo pipefail
          echo "Downloading sqlite from: ${{ github.event.inputs.exam_sql_url }}"
          mkdir -p data debug_artifact
          echo "${{ github.event.inputs.exam_sql_url }}" > debug_artifact/exam_sql_url.txt

          LOG=debug_artifact/download.log
          HEADERS=debug_artifact/headers_last.txt
          rm -f $LOG $HEADERS || true

          MAX=3
          SLEEP=3
          i=0
          while [ $i -lt $MAX ]; do
            i=$((i+1))
            echo "Attempt #$i" | tee -a $LOG
            curl -fSL -D $HEADERS -o "data/${{ github.event.inputs.exam_filename }}" -v "${{ github.event.inputs.exam_sql_url }}" 2>> $LOG || true
            if [ -s "data/${{ github.event.inputs.exam_filename }}" ]; then
              echo "Downloaded data/${{ github.event.inputs.exam_filename }} (attempt #$i)" | tee -a $LOG
              ls -l "data/${{ github.event.inputs.exam_filename }}" | tee -a $LOG
              break
            fi
            echo "Attempt #$i failed, sleeping $SLEEP seconds" | tee -a $LOG
            sleep $SLEEP
            SLEEP=$((SLEEP * 2))
          done

          if [ ! -s "data/${{ github.event.inputs.exam_filename }}" ]; then
            echo "ERROR: Failed to download sqlite after $MAX attempts" | tee -a $LOG
            echo "--- curl HEAD ---" >> $LOG
            cat $HEADERS >> $LOG || true
            echo "Uploading debug artifact for inspection..."
            ls -la debug_artifact || true
            exit 1
          fi

      - name: Upload download debug logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: download-debug-${{ github.run_id }}
          path: debug_artifact/**

      - name: Show downloaded DB
        run: |
          echo "Contents of data/:"
          ls -la data || true

      - name: Build Electron App (Windows)
        run: |
          if npm run | grep -q 'build'; then
            npm run build || true
          fi
          npx electron-builder --win --config electron-builder.yml

      - name: Find generated EXE (PowerShell)
        id: find_exe
        shell: pwsh
        run: |
          $file = Get-ChildItem -Path "dist" -Recurse -Filter *.exe | Select-Object -First 1
          if ($null -eq $file) {
            Write-Host "NO_EXE_FOUND"
            exit 2
          }
          Write-Host "Found EXE: $($file.FullName)"
          Add-Content -Path $env:GITHUB_ENV -Value ("FILE_PATH=$($file.FullName)")

      - name: Upload installer to Laravel callback (PowerShell)
        id: upload_callback
        shell: pwsh
        env:
          CALLBACK_URL: ${{ github.event.inputs.callback_url }}
          BUILD_ID: ${{ github.event.inputs.build_id }}
          FILE_PATH: ${{ env.FILE_PATH }}
        run: |
          if (-not (Test-Path $env:FILE_PATH)) {
            Write-Host "Installer not found at $env:FILE_PATH"
            exit 2
          }
          Write-Host "Posting installer $env:FILE_PATH to $env:CALLBACK_URL"
          $headers = @{ "X-BUILD-CALLBACK-TOKEN" = "${{ secrets.BUILD_CALLBACK_TOKEN }}" }
          try {
            $fileStream = [System.IO.File]::OpenRead($env:FILE_PATH)
            $content = New-Object System.Net.Http.MultipartFormDataContent
            $fileContent = New-Object System.Net.Http.StreamContent($fileStream)
            $fileContent.Headers.ContentType = [System.Net.Http.Headers.MediaTypeHeaderValue]::Parse("application/octet-stream")
            $content.Add($fileContent, "artifact", [System.IO.Path]::GetFileName($env:FILE_PATH))
            $content.Add([System.Net.Http.StringContent]::new($env:BUILD_ID), "build_id")
            $client = New-Object System.Net.Http.HttpClient
            foreach ($k in $headers.Keys) { $client.DefaultRequestHeaders.Add($k, $headers[$k]) }
            $resp = $client.PostAsync($env:CALLBACK_URL, $content).Result
            $body = $resp.Content.ReadAsStringAsync().Result
            Write-Host "Callback response status: $($resp.StatusCode.Value__)"
            Write-Host "Callback body: $body"
            if (-not ($resp.IsSuccessStatusCode)) {
              Write-Host "POST to callback returned non-success status. Exiting with code 3."
              exit 3
            }
          } catch {
            Write-Host "Exception posting to callback: $_"
            exit 3
          } finally {
            if ($fileStream) { $fileStream.Dispose() }
            if ($client) { $client.Dispose() }
          }

      - name: Upload built EXE as artifact (fallback)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: exam-installer-${{ github.run_id }}
          path: ${{ env.FILE_PATH }}

      - name: Completed
        if: success()
        run: echo "Build completed successfully"
